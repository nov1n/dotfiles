#!/usr/bin/env bash

show_prompt() {
  mapfile -t personal < <(find "$PROJECTS/personal" -mindepth 2 -maxdepth 2 -type d)
  mapfile -t work < <(find "$PROJECTS/work" -mindepth 1 -maxdepth 1 -type d)
  mapfile -t sessions < <(zellij list-sessions -s)

  declare -A session_set
  for session in "${sessions[@]}"; do
    session_set["$session"]=1
  done

  entries=()
  for session in "${sessions[@]}"; do
    entries+=($'\033[34m\033[39m '"$session")
  done
  for dir in "$NOTES_HOME" "$DOTFILES_HOME" "${personal[@]}" "${work[@]}"; do
    dir_name=$(basename "$dir")
    # Filter out dirs for which a session already exists
    if [[ -z ${session_set["$dir_name"]} ]]; then
      entries+=($'\033[36m\033[39m '"$dir")
    fi
  done

  entries_str=$(printf "%s\n" "${entries[@]}")
  if [ -n "$ZELLIJ" ]; then
    entry=$(echo "$entries_str" | fzf --prompt "  ❯ ")
  else
    entry=$(echo "$entries_str" | fzf --prompt "  ❯ " --border=sharp --margin=20,75)
  fi

  if [ -z "$entry" ]; then
    exit 1
  fi

  echo "$entry"
}

to_session_name() {
  project_dir=$1
  directory=$(basename "$project_dir")
  session_name=$(echo "$directory" | tr ' .:' '-')
  echo "$session_name"
}

entry=$(show_prompt)
cwd=$(echo "$entry" | awk '{print $2}')
session_name=$(to_session_name "$cwd")

if [[ -n "$ZELLIJ" ]]; then
  # We're inside of zellij
  if [[ "$ZELLIJ_SESSION_NAME" == "$session_name" ]]; then
    echo "Already in session '$session_name'!"
    exit 0
  fi
  zellij pipe --plugin file:~/.config/zellij/plugins/zellij-switch.wasm -- "$session_name::$cwd"
else
  if zellij list-sessions | grep "$session_name"; then
    # Session exists
    zellij attach "$session_name" -f -c
  else
    # Session does not exist, so create it
    zellij attach "$session_name" -c options --default-cwd "$cwd"
  fi
fi
